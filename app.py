import streamlit as st
import pandas as pd
# ==========================================
# ğŸ‘‡ ã“ã“ã‹ã‚‰è¿½åŠ ï¼šèƒŒæ™¯ç”»åƒã‚’è¨­å®šã™ã‚‹é­”æ³•ã®ã‚³ãƒ¼ãƒ‰
# ==========================================
def set_bg_url(url):
    st.markdown(
        f"""
        <style>
        .stApp {{
            background-image: url("{url}");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }}
        /* æ–‡å­—ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«ã€ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã‚’å°‘ã—åŠé€æ˜ã®ç™½ã«ã™ã‚‹ */
        [data-testid="stHeader"] {{
            background-color: rgba(0,0,0,0);
        }}
        </style>
        """,
        unsafe_allow_html=True
    )

# è‡ªåˆ†ã®ç”»åƒã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼
# ä¾‹: "https://raw.githubusercontent.com/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå/main/bg.jpg"
set_bg_url("ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ãŸURLã‚’è²¼ã‚Šä»˜ã‘") 

# ==========================================
# ğŸ‘† è¿½åŠ ã“ã“ã¾ã§
# ==========================================
st.set_page_config(layout="wide")
st.title('åŸä¾¡è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ')

# -------------------------------------------
# 1. ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§ä¿å­˜ï¼‰
# -------------------------------------------
# åˆå›èµ·å‹•æ™‚ã®ã¿ã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
if "master_df" not in st.session_state:
    default_data = [
        {"ææ–™å": "ç±³ç²‰", "ä»•å…¥ã‚Œå€¤": 540, "å˜ä½é‡": 1000},
        {"ææ–™å": "ã‚³ãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ", "ä»•å…¥ã‚Œå€¤": 400, "å˜ä½é‡": 1000},
        {"ææ–™å": "ç‰‡æ —ç²‰", "ä»•å…¥ã‚Œå€¤": 200, "å˜ä½é‡": 250},
        {"ææ–™å": "ä¸‰æ¸©ç³–", "ä»•å…¥ã‚Œå€¤": 300, "å˜ä½é‡": 1000},
        {"ææ–™å": "ãƒ™ãƒ¼ã‚­ãƒ³ã‚°ãƒ‘ã‚¦ãƒ€ãƒ¼", "ä»•å…¥ã‚Œå€¤": 380, "å˜ä½é‡": 100},
        {"ææ–™å": "ç‰›ä¹³", "ä»•å…¥ã‚Œå€¤": 240, "å˜ä½é‡": 1000},
        {"ææ–™å": "ç„¡ç³–ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ", "ä»•å…¥ã‚Œå€¤": 350, "å˜ä½é‡": 400},
        {"ææ–™å": "åµ", "ä»•å…¥ã‚Œå€¤": 300, "å˜ä½é‡": 10},
        {"ææ–™å": "ç±³æ²¹", "ä»•å…¥ã‚Œå€¤": 750, "å˜ä½é‡": 1300},
        {"ææ–™å": "ã‚³ã‚³ã‚¢ãƒ‘ã‚¦ãƒ€ãƒ¼", "ä»•å…¥ã‚Œå€¤": 800, "å˜ä½é‡": 200},
        {"ææ–™å": "ãƒãƒ‹ãƒ©ã‚¨ãƒƒã‚»ãƒ³ã‚¹", "ä»•å…¥ã‚Œå€¤": 500, "å˜ä½é‡": 30},
        {"ææ–™å": "æŠ¹èŒ¶ãƒ‘ã‚¦ãƒ€ãƒ¼", "ä»•å…¥ã‚Œå€¤": 1200, "å˜ä½é‡": 100},
    ]
    st.session_state.master_df = pd.DataFrame(default_data)

# -------------------------------------------
# 2. ä»•å…¥ã‚Œå€¤ã®å¤‰æ›´ã‚¨ãƒªã‚¢ï¼ˆç”»é¢ä¸Šéƒ¨ã«é…ç½®ï¼‰
# -------------------------------------------
with st.expander("ğŸ› ï¸ ã€ãƒã‚¹ã‚¿ç®¡ç†ã€‘ä»•å…¥ã‚Œå€¤ã‚’å¤‰ãˆã‚‹ãƒ»æ–°ã—ã„ææ–™ã‚’ç™»éŒ²ã™ã‚‹", expanded=False):
    st.caption("ä¸‹ã®ä¸€è¦§ã‚’ç›´æ¥æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚è¡Œã‚’è¿½åŠ ã™ã‚‹ã¨æ–°ã—ã„ææ–™ã«ãªã‚Šã¾ã™ã€‚")
    # ç·¨é›†å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
    edited_master = st.data_editor(
        st.session_state.master_df,
        num_rows="dynamic", # è¡Œã®è¿½åŠ ãƒ»å‰Šé™¤ã‚’è¨±å¯
        key="editor"
    )
    # å¤‰æ›´ã‚’ä¿å­˜
    st.session_state.master_df = edited_master

# è¨ˆç®—ç”¨ã«è¾æ›¸å½¢å¼ã«å¤‰æ›ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§æ‰±ã„ã‚„ã™ãã™ã‚‹ï¼‰
MASTER_DICT = {}
for index, row in st.session_state.master_df.iterrows():
    if row["ææ–™å"]: # ç©ºè¡Œå¯¾ç­–
        MASTER_DICT[row["ææ–™å"]] = {
            "price": row["ä»•å…¥ã‚Œå€¤"],
            "unit": row["å˜ä½é‡"]
        }

# -------------------------------------------
# 3. ãƒ¬ã‚·ãƒ”ã®æ§‹æˆã‚¨ãƒªã‚¢
# -------------------------------------------
st.divider()
st.header("ğŸ“ ãƒ¬ã‚·ãƒ”ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")

col_setup, col_calc = st.columns([1, 1])

with col_setup:
    st.subheader("â‘  ä½¿ã†ææ–™ã‚’é¸ã¶")
    # ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãƒ¬ã‚·ãƒ”ï¼ˆã“ã“ã‚‚æœ¬å½“ã¯DBåŒ–ã§ãã¾ã™ãŒã€ä¸€æ—¦ã‚³ãƒ¼ãƒ‰ã«æ›¸ãã¾ã™ï¼‰
    base_recipes = {
        "ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ¯ãƒƒãƒ•ãƒ«": ["ç±³ç²‰", "ã‚³ãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ", "ç‰‡æ —ç²‰", "ä¸‰æ¸©ç³–", "ãƒ™ãƒ¼ã‚­ãƒ³ã‚°ãƒ‘ã‚¦ãƒ€ãƒ¼", "ç‰›ä¹³", "ç„¡ç³–ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ", "åµ", "ç±³æ²¹"],
        "ãƒãƒ§ã‚³ãƒ¯ãƒƒãƒ•ãƒ«": ["ç±³ç²‰", "ã‚³ã‚³ã‚¢ãƒ‘ã‚¦ãƒ€ãƒ¼", "ã‚³ãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ", "ç‰‡æ —ç²‰", "ä¸‰æ¸©ç³–", "ãƒ™ãƒ¼ã‚­ãƒ³ã‚°ãƒ‘ã‚¦ãƒ€ãƒ¼", "ç‰›ä¹³", "ç„¡ç³–ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ", "åµ", "ç±³æ²¹"],
        "ã‚«ã‚¹ã‚¿ãƒ ï¼ˆç™½ç´™ï¼‰": []
    }
    
    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ
    selected_template = st.selectbox("ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ãƒ¬ã‚·ãƒ”ã‚’é¸æŠ", list(base_recipes.keys()))
    
    # â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼ä½¿ã†ææ–™ã‚’è‡ªç”±ã«æŠœãå·®ã—ã§ãã‚‹æ©Ÿèƒ½â˜…
    # ãƒã‚¹ã‚¿ã«ã‚ã‚‹å…¨ææ–™ã‚’é¸æŠè‚¢ã«ã™ã‚‹
    all_ingredients = list(MASTER_DICT.keys())
    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ææ–™ã‚’åˆæœŸå€¤ã«ã™ã‚‹
    default_ingredients = [img for img in base_recipes[selected_template] if img in all_ingredients]
    
    # ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆï¼ˆã‚¿ã‚°é¸æŠï¼‰ã§ææ–™ã‚’è‡ªç”±ã«è¿½åŠ ãƒ»å‰Šé™¤
    selected_ingredients = st.multiselect(
        "ã“ã®ãƒ¬ã‚·ãƒ”ã«ä½¿ã†ææ–™ï¼ˆè¿½åŠ ãƒ»å‰Šé™¤ã§ãã¾ã™ï¼‰",
        options=all_ingredients,
        default=default_ingredients
    )

with col_calc:
    st.subheader("â‘¡ åˆ†é‡ã‚’æ±ºã‚ã‚‹")
    
    total_cost = 0
    details = []

    if not selected_ingredients:
        st.info("ğŸ‘ˆ å·¦å´ã§ææ–™ã‚’é¸ã‚“ã§ãã ã•ã„")
    else:
        # é¸ã°ã‚ŒãŸææ–™ã®åˆ†é‡å…¥åŠ›æ¬„ã‚’ã‚ºãƒ©ãƒƒã¨ä¸¦ã¹ã‚‹
        for ing_name in selected_ingredients:
            data = MASTER_DICT[ing_name]
            
            # 1è¡Œã«ã€Œå…¥åŠ›æ¬„ã€ã¨ã€Œè¨ˆç®—çµæœã€ã‚’ä¸¦ã¹ã‚‹
            c1, c2 = st.columns([2, 1])
            
            with c1:
                # åˆ†é‡å…¥åŠ›
                amount = st.number_input(
                    f"{ing_name} (g ã¾ãŸã¯ å€‹)", 
                    value=0.0, 
                    step=10.0, 
                    key=f"amount_{ing_name}"
                )
            
            with c2:
                # åŸä¾¡è¨ˆç®—
                unit_price = data["price"] / data["unit"]
                cost = unit_price * amount
                total_cost += cost
                st.write(f"Â¥ {int(cost)}")
                
            details.append({
                "ææ–™": ing_name,
                "ä½¿ç”¨é‡": amount,
                "å˜ä¾¡": f"{data['price']}å††/{data['unit']}",
                "åŸä¾¡": int(cost)
            })

# -------------------------------------------
# 4. çµæœç™ºè¡¨ã‚¨ãƒªã‚¢
# -------------------------------------------
st.divider()
st.header(f"ğŸ’° åˆè¨ˆåŸä¾¡: {int(total_cost):,} å††")

# 30å€‹ã§ä½œã£ãŸå ´åˆã®1å€‹ã‚ãŸã‚Š
st.metric("1å€‹ã‚ãŸã‚Šã®åŸä¾¡ (30å€‹è£½é€ æ™‚)", f"{int(total_cost / 30):,} å††")

# ãŠã¾ã‘ï¼šè©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
with st.expander("è©³ç´°ãªå†…è¨³ã‚’è¦‹ã‚‹"):
    st.dataframe(pd.DataFrame(details))
    